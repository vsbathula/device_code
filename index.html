document.addEventListener('DOMContentLoaded', () => {
    const emailInput = document.getElementById('email');
    const userCodeInput = document.getElementById('userCode');
    const postButton = document.getElementById('postButton');
    const messageElement = document.getElementById('message');
    const emailErrorElement = document.getElementById('emailError');

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const validateForm = () => {
        const isEmailValid = emailRegex.test(emailInput.value);
        const isUserCodeValid = userCodeInput.value.replace(/-/g, '').length === 15;

        if (emailInput.value.trim() !== '' && !isEmailValid) {
            emailErrorElement.textContent = 'Please enter a valid email address.';
        } else {
            emailErrorElement.textContent = '';
        }
        
        postButton.disabled = !(isEmailValid && isUserCodeValid);
    };

    const formatUserCode = (event) => {
        // Convert the input to uppercase and remove existing hyphens
        let value = userCodeInput.value.toUpperCase().replace(/-/g, '');
        
        // Limit the length to 15 characters
        if (value.length > 15) {
            value = value.substring(0, 15);
        }

        // Add hyphens every 5 characters
        const formattedValue = value.replace(/(.{5})/g, '$1-').slice(0, -1);
        
        // Update the input field
        userCodeInput.value = formattedValue;
        
        // Run the form validation
        validateForm();
    };

    emailInput.addEventListener('input', validateForm);
    userCodeInput.addEventListener('input', formatUserCode);

    postButton.addEventListener('click', async () => {
        messageElement.textContent = '';
        messageElement.className = '';

        if (postButton.disabled) {
            messageElement.textContent = 'Please enter a valid email and user code.';
            messageElement.className = 'error';
            return;
        }

        const url = 'https://prasad.com/api/oauth2/device_authorize';
        const userCode = userCodeInput.value.replace(/-/g, '');

        const body = new URLSearchParams();
        body.append('email', emailInput.value);
        body.append('user_code', userCode);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString()
            });

            if (response.ok) {
                messageElement.textContent = 'Success! Your device is now linked.';
                messageElement.className = 'success';
            } else {
                const errorData = await response.json();
                messageElement.textContent = `Error: ${errorData.error_description || response.statusText}`;
                messageElement.className = 'error';
            }
        } catch (error) {
            messageElement.textContent = 'An error occurred while connecting to the server.';
            messageElement.className = 'error';
            console.error('Fetch error:', error);
        }
    });
});
